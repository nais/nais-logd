<match fluent.**>
  @type null
</match>

<source>
  @type tail
  path /var/log/containers/*.log
  pos_file "#{ENV['LOGD_POS_FILE_DIR']}/es-containers.log.pos"
  time_format %Y-%m-%dT%H:%M:%S.%NZ
  tag kubernetes.*
  format json
  read_from_head true
</source>

<match kubernetes.var.log.containers.**nais-logd**>
  @type null
</match>

<filter kubernetes.**>
  @type kubernetes_metadata
  preserve_json_log false
  annotation_match ^nais.io
</filter>

<filter **>
  @type record_transformer
  <record>
    type "containerlog"
    cluster "#{ENV['CLUSTER_NAME']}"
    envclass "#{ENV['CLUSTER_ENVCLASS']}"
  </record>
</filter>

<filter **>
  @type nais_logformat
</filter>

<filter **>
  @type nais_logtransform
</filter>

<filter **>
  @type nais_remap_elasticsearch
</filter>

<filter **>
  @type nais_remap_kubernetes
</filter>

<filter **>
  @type nais_remap_java
</filter>

<filter **>
  @type nais_keywords
  field exception
  regex \b[A-Z]\w+Exception\b
</filter>

<filter **>
  @type nais_keywords
  field message_code
  regex \bORA-\d{5}\b
</filter>

<filter **>
  @type nais_flatten_record
</filter>

<filter **>
  @type nais_prefix_fields
  prefix x_
  regex ^(?!(?:@timestamp$|@version$|type$|received_at$|message$|message_code$|container$|host$|namespace$|application$|pod$|thread$|component$|category$|level$|stack_trace$|exception$|cluster$|envclass$|content_length$|referer$|remote_ip$|response_code$|request$|user$|user_agent$|ident$|processing_time$|source$)).*
</filter>

<match **>
  @type elasticsearch
  include_tag_key false
  host "#{ENV['ELASTICSEARCH_HOST']}"
  port "#{ENV['ELASTICSEARCH_PORT']}"
  type_name containerlog
  logstash_prefix "#{ENV['ELASTICSEARCH_INDEX_PREFIX']}"
  logstash_format true
  buffer_chunk_limit 2M
  buffer_queue_limit 32
  flush_interval 5s
  max_retry_wait 30
  disable_retry_limit
  num_threads 8
</match>
